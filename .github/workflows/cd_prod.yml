  name: CI
  on:
    push:
      branches:
        - master
  jobs:
    flutter_analyze:
      runs-on: ubuntu-latest
      name: Run flutter analyze
      steps:
        - uses: actions/checkout@v4
        - uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.16.9'
            channel: 'stable'
        - run: flutter --version
        - run: flutter pub get
        - run: flutter analyze
    flutter_test:
      runs-on: ubuntu-latest
      name: Run flutter test
      needs: [flutter_analyze]
      steps:
        - uses: actions/checkout@v4
        - uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.16.9'
            channel: 'stable'
        - run: flutter pub get
        - run: flutter test
    flutter_build_appbundle:
      runs-on: ubuntu-latest
      name: Build and Release Prod (Android)
      needs: [flutter_test]
      steps:
        - uses: actions/checkout@v4
        - uses: subosito/flutter-action@v2
          with:
            flutter-version: '3.16.9'
            channel: 'stable'
        - name: Get latest app version
          id: version
          uses: MakeAndDevelop/firebase-appversion@v1
          with:
            appId: ${{secrets.APP_ID}}
            projectNumber: ${{secrets.FIREBASE_PROJECT_NUMBER}}
            serviceAccount: ${{secrets.CREDENTIAL_FILE_CONTENT}}

        # For flutter use below to increment version:
        - name: Update version in YAML
          run: |
            sed -i 's/version: [0-9]*\.[0-9]*\.[0-9]*+[0-9]*/version: ${{ steps.version.outputs.newFlutterVersionString }}/' pubspec.yaml
        - run: flutter pub get
        - run: flutter clean
        - name: Build android apk
          run: flutter build apk --debug
        - name: List Android apk folder
          run: ls build/app/outputs/flutter-apk
        - uses: wzieba/Firebase-Distribution-Github-Action@v1
          name: upload artifact to Firebase App Distribution
          with:
            appId: ${{secrets.APP_ID}}
            serviceCredentialsFileContent: ${{secrets.CREDENTIAL_FILE_CONTENT}}
            groups: prod
            file: build/app/outputs/flutter-apk/app-debug.apk